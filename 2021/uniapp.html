<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 使用 uniapp 和 vant 的遇到问题记录 · lyn's blog</title><meta name="description" content="解决vant组件库的ImagePreview在uniapp中无法使用的问题"><meta name="keywords" content="uniapp,vant,报错,Javascript,CSS3,HTML5,vue,react,小程序"><meta name="viewport" content="width=device-width, initial-scale=1"><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><link rel="icon" href="/blog/favicon.png"><link rel="stylesheet" href="/blog/css/apollo.css"><style type="text/css">
.spoiler {
  display: inline-flex;
}
p.spoiler {
  display: flex;
}
.spoiler a {
  pointer-events: none;
}
.spoiler-blur, .spoiler-blur > * {
  transition: text-shadow .5s ease;
}
.spoiler .spoiler-blur, .spoiler .spoiler-blur > * {
  color: rgba(0, 0, 0, 0);
  background-color: rgba(0, 0, 0, 0);
  text-shadow: 0 0 10px grey;
  cursor: pointer;
}
.spoiler .spoiler-blur:hover, .spoiler .spoiler-blur:hover > * {
  text-shadow: 0 0 5px grey;
}
.spoiler-box, .spoiler-box > * {
  transition: color .5s ease,
  background-color .5s ease;
}
.spoiler .spoiler-box, .spoiler .spoiler-box > * {
  color: black;
  background-color: black;
  text-shadow: none;
}</style><meta name="generator" content="Hexo 5.4.0"></head><body><div class="wrap"><header><a href="/blog/" class="logo-link"><img src="/blog/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/blog/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/blog/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/yzllee" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/blog/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">使用 uniapp 和 vant 的遇到问题记录</h1><div class="post-tags"><a href="/blog/tags/Javascript/" class="tag-title">#Javascript</a><a href="/blog/tags/uniapp/" class="tag-title">#uniapp</a><a href="/blog/tags/vant/" class="tag-title">#vant</a></div><div class="post-info">2021年7月15日</div><div class="post-content"><p>在项目中需要用<code>vant</code>组件库的<code>ImagePreview</code>组件遇到报错，导致组件无法正常使用。</p>
<span id="more"></span>
<p>按照<code>vant</code>的文档使用<code>ImagePreview</code>时，浏览器抛出了下面的异常错误：<br><img src="/blog/images/uniapp采坑记录1-1.png" alt="错误提示"></p>
<p>通过浏览器断点调试，发现是<code>ImagePreview</code>组件中的<code>ImagePreviewItem</code>组件在渲染<code>Image</code>组件时报错了，如下图：<br><img src="/blog/images/uniapp采坑记录1-2.png" alt="错误提示"></p>
<p>从报错中看到<code>this.onLoad</code>方法是<code>undefined</code>,从图中还可以看到已经定义过<code>onLoad</code>方法了，那为什么<code>onLoad</code>方法消失了呢？</p>
<h2 id="探索原因"><a href="#探索原因" class="headerlink" title="探索原因"></a>探索原因</h2><p><code>uniapp</code><a target="_blank" rel="noopener" href="https://uniapp.dcloud.net.cn/frame?id=%e9%a1%b5%e9%9d%a2%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f">官方文档</a>中写着页面的生命周期中包含<code>onLoad</code>方法，怀疑是与此方法冲突导致，但是为什么会影响到组件<code>methods</code>中方法还未知原因。</p>
<p>然后我再一个普通的页面的<code>methods</code>中也写了一个<code>onLoad</code>方法，发现他竟然直接被当做生命周期执行了，绑定在<code>DOM</code>上的<code>onLoad</code>也变成了<code>undefiend</code>。现在有理由证明是<code>uniapp</code>对页面或组件的<code>vue</code>实例进行操作。</p>
<p>经过翻阅<code>uniapp</code>的<a target="_blank" rel="noopener" href="https://github.com/dcloudio/uni-app/blob/0edd43ecafaebd2b7a638ecccf3d527702eecf43/src/core/service/plugins/lifecycle.js#L79">源码</a>发现，他为了支持自己框架的一些<code>life cycle hooks</code>，对页面或组件的<code>vue</code>实例进行了<code>mixin</code>操作，可以看到，当页面或组件的<code>methods</code>包含了与框架生命周期同名的函数，将会被直接绑定实例外层，然后从<code>methods</code>中删除。<br><img src="/blog/images/uniapp采坑记录1-3.png" alt="错误提示"><br>经过<code>debug</code>，也完全证实了上面的结论。</p>
<h2 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h2><p>既然已经发现了问题的原因，那要如何解决问题呢？<code>uniapp</code>和<code>vant</code>都是第三方库,去给他们提<code>issue</code>让两边的团队去协商解决吧，这显然是不可能的。或者放弃使用<code>uniapp</code>或者<code>vant</code>？这个主意不错，但是并不能解决根本问题，当你发现其他<code>vant</code>组件或其他者第三方组件也有冲突时，要怎么办呢。</p>
<p>我想到代码都是要通过<code>babel</code>转义的，那我是不是能通过<code>babel-plugin</code> 来解决呢？后来发现，项目中的<code>babel-plugin</code>只能对本地代码的<code>AST</code>语法树进行操作，并不能解析到第三方库的代码，因为他们都是通过<code>import</code>导入进来的，<code>babel-plugin</code>只能解析到<code>import</code>的<code>AST</code>。</p>
<p>仔细一想，解析第三方库的话，用<code>babel-loader</code>就好了。于是我便写了一个替换方法名的<code>loader</code>，并在<code>vue.config.js</code>中添加了对<code>vant</code>库的<code>loader</code>。<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// fixConflictLoader.js</span></span><br><span class="line"><span class="keyword">const</span> mixedNameReg = <span class="regexp">/\b(onLoad|onError)\b/g</span>;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">source</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> _source = source;</span><br><span class="line">  <span class="keyword">if</span> (mixedNameReg.<span class="title function_">test</span>(_source)) &#123;</span><br><span class="line">    _source = _source.<span class="title function_">replace</span>(mixedNameReg, <span class="keyword">function</span> (<span class="params">$<span class="number">0</span></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> $<span class="number">0</span> + <span class="string">&quot;InVant&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> _source;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> source;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// vue.config.js</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> fixConflictLoader = path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;./fixConflictLoader&quot;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">chainWebpack</span>: <span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">    config.<span class="property">module</span></span><br><span class="line">    .<span class="title function_">rule</span>(<span class="string">&quot;compile&quot;</span>)</span><br><span class="line">    .<span class="title function_">test</span>(<span class="regexp">/\.js$/</span>)</span><br><span class="line">    .<span class="property">include</span>.<span class="title function_">add</span>(<span class="title function_">resolve</span>(<span class="string">&quot;node_modules/vant/es&quot;</span>)) <span class="comment">// vant 的按需引入使用的是此项目包</span></span><br><span class="line">    .<span class="title function_">end</span>()</span><br><span class="line">    .<span class="title function_">use</span>(fixConflictLoader)</span><br><span class="line">    .<span class="title function_">loader</span>(fixConflictLoader);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这个方法非常的暴力，直接解析<code>vant</code>的源码，然后批量替换其中与<code>uniapp</code>生命周期冲突的方法名，实际也解决了我所遇到的问题。</p>
<p><strong>如果你有更好的方法，欢迎与我探讨交流。</strong></p>
</div></article></div></main><footer><div class="paginator"><a href="/blog/2021/open-xcx-by-link.html" class="next">下一篇</a></div><div id="comments" class="comments"><script src="https://utteranc.es/client.js" repo="yzllee/blog-discuss" issue-term="title" theme="github-light" crossorigin="anonymous" async></script></div><div class="copyright"><p>© 2015 - 2022 <a href="http://www.lynth.cn/blog">Lyn</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-213603722-1",'auto');ga('send','pageview');</script></body></html>